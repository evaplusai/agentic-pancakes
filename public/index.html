<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Aura Agent - Your Content Companion</title>
    <!-- v3 - Split View with Header -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Ambient background stars */
        .stars {
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            opacity: 0;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0; }
            50% { opacity: 0.8; }
        }

        /* Header branding - same as chat.html */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            background: linear-gradient(to bottom, rgba(10, 10, 15, 0.95), transparent);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-icon {
            font-size: 28px;
            animation: float 3s ease-in-out infinite;
        }

        .brand-icon-svg {
            animation: float 3s ease-in-out infinite;
            display: none; /* Hidden - using orb instead */
        }

        /* Header Orb - 2x logo size */
        .header-orb-container {
            position: relative;
            width: 56px;
            height: 56px;
        }

        #headerOrbCanvas {
            width: 100%;
            height: 100%;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .brand-text {
            display: flex;
            flex-direction: column;
        }

        .brand-name {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, #a78bfa, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .brand-tagline {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            letter-spacing: 1px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* User Selector Dropdown */
        .user-selector {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
        }

        .user-selector:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(168, 85, 247, 0.4);
        }

        .user-avatar {
            font-size: 20px;
            line-height: 1;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-name {
            font-size: 13px;
            font-weight: 600;
            color: white;
        }

        .user-type {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
        }

        .user-dropdown-arrow {
            margin-left: auto;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            transition: transform 0.2s ease;
        }

        .user-selector.open .user-dropdown-arrow {
            transform: rotate(180deg);
        }

        .user-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: rgba(26, 26, 46, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 8px 0;
            min-width: 220px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }

        .user-selector.open .user-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .user-option:hover {
            background: rgba(168, 85, 247, 0.15);
        }

        .user-option.selected {
            background: rgba(168, 85, 247, 0.2);
        }

        .user-option .user-avatar {
            font-size: 24px;
        }

        .user-option-info {
            flex: 1;
        }

        .user-option-name {
            font-size: 13px;
            font-weight: 600;
            color: white;
        }

        .user-option-desc {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            max-width: 160px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-option-check {
            color: #a855f7;
            font-size: 14px;
            opacity: 0;
        }

        .user-option.selected .user-option-check {
            opacity: 1;
        }

        /* Mic button in choices */
        .chat-choice-btn.mic-choice {
            background: rgba(168, 85, 247, 0.15);
            border-color: rgba(168, 85, 247, 0.4);
        }

        .chat-choice-btn.mic-choice:hover {
            background: rgba(168, 85, 247, 0.25);
            border-color: rgba(168, 85, 247, 0.6);
        }

        .chat-choice-btn.mic-choice.listening {
            background: rgba(168, 85, 247, 0.3);
            border-color: #a855f7;
            animation: micPulse 1.5s ease-in-out infinite;
        }

        @keyframes micPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(168, 85, 247, 0); }
        }

        .chat-choice-btn.mic-choice .emoji {
            font-size: 18px;
        }

        /* About Button */
        .about-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.7);
        }

        .about-button:hover {
            background: rgba(168, 85, 247, 0.2);
            border-color: rgba(168, 85, 247, 0.4);
            color: #a855f7;
        }

        /* About Modal */
        .about-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .about-modal-overlay.active {
            display: flex;
        }

        .about-modal {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .about-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 28px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .about-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            background: linear-gradient(135deg, #a855f7, #6366f1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .about-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 20px;
            transition: all 0.2s ease;
        }

        .about-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .about-content {
            padding: 28px;
        }

        .about-section {
            margin-bottom: 28px;
        }

        .about-section:last-child {
            margin-bottom: 0;
        }

        .about-section h3 {
            font-size: 16px;
            font-weight: 600;
            color: #a855f7;
            margin: 0 0 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .about-section p {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
            margin: 0;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .feature-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 14px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .feature-item .icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .feature-item .text {
            flex: 1;
        }

        .feature-item .title {
            font-size: 13px;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .feature-item .desc {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            line-height: 1.4;
        }

        .tech-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .tech-tag {
            background: rgba(168, 85, 247, 0.15);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 11px;
            color: #c084fc;
            font-weight: 500;
        }

        .about-footer {
            padding: 20px 28px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .about-footer p {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.4);
            margin: 0;
        }

        .about-footer a {
            color: #a855f7;
            text-decoration: none;
        }

        .about-footer a:hover {
            text-decoration: underline;
        }

        /* Architecture & Flow Diagrams */
        .architecture-diagram,
        .algorithm-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(168, 85, 247, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
            overflow-x: auto;
        }

        .architecture-diagram pre,
        .algorithm-box pre {
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 10px;
            line-height: 1.4;
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
            white-space: pre;
            overflow-x: auto;
        }

        /* User Flow Diagram */
        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }

        .flow-step {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 10px;
            padding: 12px;
            flex: 1;
            min-width: 120px;
        }

        .step-number {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #a855f7, #6366f1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: white;
            flex-shrink: 0;
        }

        .step-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .step-content strong {
            font-size: 12px;
            color: white;
        }

        .step-content span {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
        }

        .flow-arrow {
            font-size: 20px;
            color: rgba(168, 85, 247, 0.5);
            flex-shrink: 0;
        }

        /* API Table */
        .api-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 11px;
        }

        .api-table th,
        .api-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .api-table th {
            background: rgba(168, 85, 247, 0.15);
            color: #c084fc;
            font-weight: 600;
            font-size: 11px;
        }

        .api-table td {
            color: rgba(255, 255, 255, 0.7);
        }

        .api-table code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: #22d3ee;
        }

        /* Tech Categories */
        .tech-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .tech-category {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 12px;
        }

        .tech-category h4 {
            font-size: 11px;
            font-weight: 600;
            color: #a855f7;
            margin: 0 0 8px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tech-category ul {
            margin: 0;
            padding-left: 16px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.6;
        }

        /* Responsive adjustments for About modal */
        @media (max-width: 600px) {
            .about-modal {
                max-width: 100%;
                max-height: 90vh;
                margin: 10px;
            }

            .flow-diagram {
                flex-direction: column;
            }

            .flow-arrow {
                transform: rotate(90deg);
            }

            .flow-step {
                width: 100%;
            }

            .architecture-diagram pre,
            .algorithm-box pre {
                font-size: 8px;
            }
        }

        .audio-toggle, .mic-button-header {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .audio-toggle:hover, .mic-button-header:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .audio-icon, .mic-icon {
            width: 20px;
            height: 20px;
            fill: white;
        }

        /* Single Column Container */
        .split-container {
            display: flex;
            min-height: 100vh;
            padding-top: 70px; /* Space for header */
            position: relative;
            z-index: 1;
        }

        /* Left Panel - REMOVED */
        .left-panel {
            display: none;
        }

        /* Orb container - canvas based like chat.html */
        .orb-container {
            position: relative;
            width: 140px;
            height: 140px;
            display: none; /* Hidden - moved to header */
        }

        #orbCanvas {
            width: 100%;
            height: 100%;
        }

        /* Chat Choice Buttons - appear inline in conversation */
        .chat-choices {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }

        .chat-choice-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 10px 18px;
            font-size: 14px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-choice-btn:hover {
            background: rgba(168, 85, 247, 0.2);
            border-color: rgba(168, 85, 247, 0.5);
            transform: translateY(-2px);
        }

        .chat-choice-btn .emoji {
            font-size: 16px;
        }

        .chat-choice-btn .label {
            font-weight: 500;
        }

        /* Right Panel - Chat Interface (Now Full Width) */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 70px);
            position: relative;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        /* Chat Messages */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        .message {
            max-width: 85%;
            padding: 16px 20px;
            border-radius: 20px;
            backdrop-filter: blur(20px);
            animation: fadeInUp 0.4s ease;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.ai {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .message.user {
            align-self: flex-end;
            background: rgba(168, 85, 247, 0.2);
            border: 1px solid rgba(168, 85, 247, 0.4);
        }

        /* Content Card in Chat */
        .content-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            overflow: hidden;
            margin-top: 12px;
            max-width: 400px;
        }

        .card-image-container {
            width: 100%;
            height: 180px;
            position: relative;
            overflow: hidden;
        }

        .card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-image-fallback {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .movie-icon {
            font-size: 48px;
            opacity: 0.8;
        }

        .card-content {
            padding: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .card-match {
            color: #4ade80;
            font-size: 13px;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .card-scores {
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
        }

        .card-score {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.08);
        }

        .card-score.match {
            color: #4ade80;
            border: 1px solid rgba(74, 222, 128, 0.3);
        }

        .card-score.utility {
            color: #60a5fa;
            border: 1px solid rgba(96, 165, 250, 0.3);
        }

        .card-provenance {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 2px solid rgba(168, 85, 247, 0.5);
        }

        .card-provenance-stat {
            color: #a78bfa;
            font-weight: 500;
        }

        .card-provenance-skill {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .skill-badge {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.3), rgba(236, 72, 153, 0.3));
            border: 1px solid rgba(168, 85, 247, 0.4);
            border-radius: 12px;
            padding: 3px 10px;
            font-size: 10px;
            font-weight: 600;
            color: #e9d5ff;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .skill-badge .skill-icon {
            font-size: 11px;
        }

        .skill-confidence {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.4);
        }

        .card-provenance-weights {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 6px;
        }

        .weight-pill {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 8px;
            background: rgba(96, 165, 250, 0.15);
            color: #93c5fd;
            border: 1px solid rgba(96, 165, 250, 0.2);
        }

        .weight-pill.causal {
            background: rgba(74, 222, 128, 0.15);
            color: #86efac;
            border-color: rgba(74, 222, 128, 0.2);
        }

        .weight-pill.causal.positive {
            background: rgba(74, 222, 128, 0.25);
        }

        .card-diversity-label {
            display: inline-block;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            margin-bottom: 8px;
            background: rgba(168, 85, 247, 0.2);
            color: #c4b5fd;
            font-weight: 500;
        }

        .card-diversity-label.safe {
            background: rgba(74, 222, 128, 0.15);
            color: #86efac;
        }

        .card-diversity-label.fast {
            background: rgba(251, 191, 36, 0.15);
            color: #fcd34d;
        }

        .card-diversity-label.adventurous {
            background: rgba(244, 114, 182, 0.15);
            color: #f9a8d4;
        }

        .card-meta {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 6px;
        }

        .card-genres {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 10px;
        }

        .card-description {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
            margin-bottom: 14px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        /* Alternatives Section */
        .alternatives-section {
            margin-top: 16px;
        }

        .alternatives-header {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .alternatives-grid {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .alt-card {
            flex: 1;
            min-width: 160px;
            max-width: 200px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .alt-card:hover {
            background: rgba(168, 85, 247, 0.1);
            border-color: rgba(168, 85, 247, 0.3);
            transform: translateY(-2px);
        }

        .alt-card-poster {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .alt-card-title {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .alt-card-meta {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
        }

        .alt-card-label {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            display: inline-block;
            margin-top: 6px;
        }

        /* Voice Input Styles */
        .mic-button-header.listening {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.6);
            animation: pulse-mic 1.5s infinite;
        }

        @keyframes pulse-mic {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        .voice-transcript {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-top: 8px;
        }

        .card-button {
            flex: 1;
            padding: 10px 12px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .card-button.primary {
            background: rgba(168, 85, 247, 0.3);
            color: white;
            border: 1px solid rgba(168, 85, 247, 0.5);
        }

        .card-button.secondary {
            background: rgba(255, 255, 255, 0.08);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .card-button:hover {
            transform: translateY(-1px);
        }

        /* Quick Chips */
        .quick-chips {
            display: flex;
            gap: 10px;
            padding: 16px 30px 24px;
            flex-wrap: wrap;
            justify-content: center;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .chip {
            padding: 10px 18px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .chip:hover {
            background: rgba(168, 85, 247, 0.2);
            border-color: rgba(168, 85, 247, 0.4);
            transform: translateY(-2px);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .split-container {
                flex-direction: column;
            }

            /* Header mobile layout - brand left, icons right */
            .header {
                flex-wrap: nowrap;
                padding: 10px 12px;
                gap: 8px;
                justify-content: space-between;
            }

            .brand {
                gap: 8px;
                flex-shrink: 1;
                min-width: 0;
            }

            /* Push profile and icons to right */
            .header-right {
                margin-left: auto;
                flex-shrink: 0;
            }

            /* Keep orb size decent on mobile */
            .header-orb-container {
                width: 40px;
                height: 40px;
                flex-shrink: 0;
            }

            .brand-name {
                font-size: 18px;
            }

            .brand-tagline {
                font-size: 9px;
            }

            /* Reduce gap between icons */
            .header-right {
                gap: 6px;
            }

            /* Hide user type on mobile to save space */
            .user-type {
                display: none;
            }

            .user-selector {
                min-width: auto;
                padding: 4px 8px;
            }

            .user-name {
                font-size: 12px;
            }

            .user-avatar {
                font-size: 16px;
            }

            /* Smaller icon buttons */
            .about-button,
            .audio-toggle,
            .mic-button-header {
                width: 32px;
                height: 32px;
            }

            .about-button svg,
            .audio-toggle svg,
            .mic-button-header svg {
                width: 16px;
                height: 16px;
            }

            .right-panel {
                padding: 10px;
                max-height: none;
            }

            .chat-messages {
                padding: 20px 12px;
            }

            /* Smaller choice buttons on mobile */
            .chat-choice-btn {
                padding: 8px 12px;
                font-size: 13px;
                gap: 6px;
            }

            .chat-choice-btn .emoji {
                font-size: 14px;
            }

            .content-card {
                max-width: 100%;
            }

            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Extra small screens */
        @media (max-width: 380px) {
            .header-orb-container {
                width: 32px;
                height: 32px;
            }

            .brand-name {
                font-size: 16px;
            }

            .brand-tagline {
                display: none;
            }

            .chat-choice-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Ambient stars -->
    <div class="stars" id="stars"></div>

    <!-- Header branding with Orb -->
    <div class="header">
        <div class="brand">
            <!-- Animated Orb replacing logo - 2x size (56px vs 28px) -->
            <div class="header-orb-container">
                <canvas id="headerOrbCanvas"></canvas>
            </div>
            <div class="brand-text">
                <span class="brand-name">Aura Agent</span>
                <span class="brand-tagline">Your Content Companion</span>
            </div>
        </div>
        <div class="header-right">
            <!-- User Selector -->
            <div class="user-selector" id="userSelector">
                <span class="user-avatar" id="currentUserAvatar">ğŸ§­</span>
                <div class="user-info">
                    <span class="user-name" id="currentUserName">Alex</span>
                    <span class="user-type" id="currentUserType">Explorer</span>
                </div>
                <span class="user-dropdown-arrow">â–¼</span>
                <div class="user-dropdown" id="userDropdown">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <button class="about-button" id="aboutButton" title="About this app">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                </svg>
            </button>
            <div class="audio-toggle" id="audioToggle" title="Toggle ambient sound">
                <svg class="audio-icon" viewBox="0 0 24 24">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                </svg>
            </div>
            <button class="mic-button-header" id="micButton" title="Voice input">
                <svg class="mic-icon" viewBox="0 0 24 24">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- About Modal -->
    <div class="about-modal-overlay" id="aboutModal">
        <div class="about-modal">
            <div class="about-header">
                <h2>About Aura Agent</h2>
                <button class="about-close" id="aboutClose">&times;</button>
            </div>
            <div class="about-content">
                <!-- Overview Section -->
                <div class="about-section">
                    <h3>ğŸ¬ What is Aura Agent?</h3>
                    <p>Aura Agent is an <strong>emotion-first content discovery platform</strong> that revolutionizes how you find movies and TV shows. Instead of endless scrolling through catalogs, simply tell us your mood and we'll find your perfect watch in under 60 seconds.</p>
                    <p style="margin-top: 12px;">The platform combines <strong>conversational AI</strong>, <strong>semantic search</strong>, and <strong>personalized learning</strong> to understand not just what you want to watch, but <em>why</em> you want to watch it.</p>
                </div>

                <!-- How It Works -->
                <div class="about-section">
                    <h3>ğŸ”„ How It Works</h3>
                    <div class="architecture-diagram">
                        <pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      USER INTERACTION LAYER                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ¤ Voice Input    ğŸ’¬ Chat UI    ğŸ‘† Quick Choices    ğŸ‘¤ Personas â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RECOMMENDATION ENGINE                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚  Mood/Tone   â”‚â”€â”€â”€â–¶â”‚   Vector     â”‚â”€â”€â”€â–¶â”‚   Utility    â”‚     â”‚
â”‚   â”‚  Detection   â”‚    â”‚   Search     â”‚    â”‚   Scoring    â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚          â”‚                   â”‚                   â”‚              â”‚
â”‚          â–¼                   â–¼                   â–¼              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚   Context    â”‚    â”‚  RuVector    â”‚    â”‚  Diversity   â”‚     â”‚
â”‚   â”‚   Analysis   â”‚    â”‚  Embeddings  â”‚    â”‚   Filter     â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      LEARNING LAYER                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“Š ReasoningBank  â”‚  ğŸ§  Reflexion  â”‚  ğŸ”— Causal  â”‚  ğŸ“š Skills  â”‚
â”‚                    â”‚     Memory     â”‚    Graph    â”‚   Library   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       DATA SOURCES                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      ğŸ¥ TMDB API (Real-time)    â”‚    ğŸ‘¤ User Profiles (Local)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        </pre>
                    </div>
                </div>

                <!-- User Flow -->
                <div class="about-section">
                    <h3>ğŸ‘¤ User Journey</h3>
                    <div class="flow-diagram">
                        <div class="flow-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <strong>Select Mood</strong>
                                <span>ğŸŒ™ Unwind (relax) or âš¡ Engage (stimulate)</span>
                            </div>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <strong>Choose Tone</strong>
                                <span>ğŸ˜„ Laugh, ğŸ­ Feel, ğŸ”¥ Thrill, or ğŸ§  Think</span>
                            </div>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <strong>Get Recommendations</strong>
                                <span>AI-curated picks with provenance</span>
                            </div>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <strong>Refine or Watch</strong>
                                <span>Explore alternatives or start watching</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Features -->
                <div class="about-section">
                    <h3>âœ¨ Key Features</h3>
                    <div class="feature-grid">
                        <div class="feature-item">
                            <span class="icon">ğŸ­</span>
                            <div class="text">
                                <div class="title">Mood-Based Discovery</div>
                                <div class="desc">Our 2x2 mood matrix (Unwind/Engage Ã— 4 tones) maps directly to psychological viewing states, not just genres</div>
                            </div>
                        </div>
                        <div class="feature-item">
                            <span class="icon">ğŸ¤</span>
                            <div class="text">
                                <div class="title">Voice Input</div>
                                <div class="desc">Web Speech API integration lets you speak naturally - "I want something funny" or "thrill me tonight"</div>
                            </div>
                        </div>
                        <div class="feature-item">
                            <span class="icon">ğŸ‘¥</span>
                            <div class="text">
                                <div class="title">User Personas</div>
                                <div class="desc">5 distinct viewer profiles with pre-built watch histories to demonstrate personalization differences</div>
                            </div>
                        </div>
                        <div class="feature-item">
                            <span class="icon">ğŸ§ </span>
                            <div class="text">
                                <div class="title">AI Provenance</div>
                                <div class="desc">Every recommendation shows WHY it was chosen - trajectory count, confidence intervals, and reasoning chain</div>
                            </div>
                        </div>
                        <div class="feature-item">
                            <span class="icon">ğŸ“Š</span>
                            <div class="text">
                                <div class="title">Smart Alternatives</div>
                                <div class="desc">Three diverse picks per query: âœ“ Safe Choice (best match), âš¡ Quick Watch (shortest), ğŸ² Adventurous (different)</div>
                            </div>
                        </div>
                        <div class="feature-item">
                            <span class="icon">ğŸ”„</span>
                            <div class="text">
                                <div class="title">Continuous Learning</div>
                                <div class="desc">ReasoningBank tracks trajectories, learns patterns, and adjusts recommendation weights over time</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommendation Algorithm -->
                <div class="about-section">
                    <h3>âš™ï¸ Recommendation Algorithm</h3>
                    <p>Our utility scoring combines multiple factors with learned weights:</p>
                    <div class="algorithm-box">
                        <pre>
Utility Score = Î£ (Factor Ã— Weight)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Factor             â”‚ Weight     â”‚ Description                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Vector Similarity  â”‚ 0.45       â”‚ Semantic match to mood/tone      â”‚
â”‚ Context Boost      â”‚ 0.25       â”‚ Time of day, device, weekend     â”‚
â”‚ Trending Boost     â”‚ 0.15       â”‚ Currently popular content        â”‚
â”‚ Diversity Penalty  â”‚ -0.10      â”‚ Avoid repetitive recommendations â”‚
â”‚ Latency Penalty    â”‚ -0.05      â”‚ Prefer faster-loading content    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Weights are dynamically adjusted by ReasoningBank based on outcomes!
                        </pre>
                    </div>
                </div>

                <!-- Learning System -->
                <div class="about-section">
                    <h3>ğŸ§  Learning System Architecture</h3>
                    <div class="architecture-diagram">
                        <pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LEARNING COMPONENTS                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  REASONINGBANK   â”‚     â”‚ REFLEXION MEMORY â”‚     â”‚  CAUSAL GRAPH    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                  â”‚     â”‚                  â”‚     â”‚                  â”‚
â”‚ â€¢ Trajectories   â”‚     â”‚ â€¢ Episode Store  â”‚     â”‚ â€¢ Intervention   â”‚
â”‚ â€¢ Verdict Judge  â”‚     â”‚ â€¢ Pattern Match  â”‚     â”‚   Tracking       â”‚
â”‚ â€¢ Weight Tuning  â”‚     â”‚ â€¢ Avoid Rules    â”‚     â”‚ â€¢ Causal Links   â”‚
â”‚ â€¢ Success Rate   â”‚     â”‚ â€¢ Reflection     â”‚     â”‚ â€¢ Uplift Calc    â”‚
â”‚                  â”‚     â”‚   Summaries      â”‚     â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                        â”‚                        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SKILL LIBRARY   â”‚     â”‚  GNN ATTENTION   â”‚     â”‚  SELF-HEALING    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                  â”‚     â”‚                  â”‚     â”‚                  â”‚
â”‚ â€¢ Friday Unwind  â”‚     â”‚ â€¢ 8-Head Attn    â”‚     â”‚ â€¢ Health Checks  â”‚
â”‚ â€¢ Late Night     â”‚     â”‚ â€¢ User-Content   â”‚     â”‚ â€¢ Fallback Mode  â”‚
â”‚ â€¢ Weekend Disc.  â”‚     â”‚   Embeddings     â”‚     â”‚ â€¢ Auto Recovery  â”‚
â”‚ â€¢ Recovery Pivot â”‚     â”‚ â€¢ 64-dim Vectors â”‚     â”‚ â€¢ Anomaly Detect â”‚
â”‚                  â”‚     â”‚                  â”‚     â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        </pre>
                    </div>
                </div>

                <!-- Vector Search -->
                <div class="about-section">
                    <h3>ğŸ” RuVector Semantic Search</h3>
                    <p>Our custom vector store uses n-gram embeddings for content matching:</p>
                    <div class="algorithm-box">
                        <pre>
Content Embedding Pipeline:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. TEXT PROCESSING
   "The Dark Knight" â†’ ["the", "dark", "knight", "th", "he", "da", ...]

2. N-GRAM TOKENIZATION
   â€¢ Unigrams: ["dark", "knight", "action", "thriller"]
   â€¢ Bigrams:  ["da", "ar", "rk", "kn", "ni", "ig", "gh", "ht"]
   â€¢ Trigrams: ["dar", "ark", "rkn", "kni", "nig", "igh", "ght"]

3. EMBEDDING GENERATION
   Token hashes â†’ 128-dimensional vector
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ [0.23, -0.45, 0.12, 0.67, -0.89, 0.34, ... ] (128 dims) â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4. SIMILARITY SEARCH
   Query: "dark thriller" â†’ Cosine similarity â†’ Top K results
                        </pre>
                    </div>
                </div>

                <!-- Technology Stack -->
                <div class="about-section">
                    <h3>ğŸ› ï¸ Technology Stack</h3>
                    <p>Built with modern AI/ML technologies and best practices:</p>
                    <div class="tech-categories">
                        <div class="tech-category">
                            <h4>Frontend</h4>
                            <div class="tech-tags">
                                <span class="tech-tag">Vanilla JS</span>
                                <span class="tech-tag">Web Speech API</span>
                                <span class="tech-tag">Canvas (Orb)</span>
                                <span class="tech-tag">CSS Animations</span>
                            </div>
                        </div>
                        <div class="tech-category">
                            <h4>Backend</h4>
                            <div class="tech-tags">
                                <span class="tech-tag">TypeScript</span>
                                <span class="tech-tag">Express.js</span>
                                <span class="tech-tag">Node.js</span>
                                <span class="tech-tag">MCP Protocol</span>
                            </div>
                        </div>
                        <div class="tech-category">
                            <h4>AI/ML</h4>
                            <div class="tech-tags">
                                <span class="tech-tag">RuVector Embeddings</span>
                                <span class="tech-tag">Semantic Search</span>
                                <span class="tech-tag">GNN Attention</span>
                                <span class="tech-tag">Causal Inference</span>
                            </div>
                        </div>
                        <div class="tech-category">
                            <h4>Learning</h4>
                            <div class="tech-tags">
                                <span class="tech-tag">ReasoningBank</span>
                                <span class="tech-tag">Reflexion Memory</span>
                                <span class="tech-tag">Skill Library</span>
                                <span class="tech-tag">Self-Healing</span>
                            </div>
                        </div>
                        <div class="tech-category">
                            <h4>Data</h4>
                            <div class="tech-tags">
                                <span class="tech-tag">TMDB API</span>
                                <span class="tech-tag">In-Memory Store</span>
                                <span class="tech-tag">User Profiles</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Endpoints -->
                <div class="about-section">
                    <h3>ğŸ”Œ API Endpoints</h3>
                    <div class="api-table">
                        <table>
                            <tr><th>Method</th><th>Endpoint</th><th>Description</th></tr>
                            <tr><td>POST</td><td>/api/recommend</td><td>Get mood-based recommendations with alternatives</td></tr>
                            <tr><td>GET</td><td>/api/trending</td><td>Fetch currently trending content from TMDB</td></tr>
                            <tr><td>POST</td><td>/api/search</td><td>Semantic text search across content</td></tr>
                            <tr><td>GET</td><td>/api/demo-users</td><td>List all demo user personas</td></tr>
                            <tr><td>GET</td><td>/api/user/:id</td><td>Get user profile and history</td></tr>
                            <tr><td>GET</td><td>/api/learning/stats</td><td>View learning system statistics</td></tr>
                            <tr><td>GET</td><td>/api/health</td><td>System health check</td></tr>
                        </table>
                    </div>
                </div>

                <!-- User Personas -->
                <div class="about-section">
                    <h3>ğŸ‘¥ Demo User Personas</h3>
                    <p>Switch between profiles to see how recommendations change based on viewing history:</p>
                    <div class="feature-grid">
                        <div class="feature-item">
                            <span class="icon">ğŸ§­</span>
                            <div class="text">
                                <div class="title">Alex (The Explorer)</div>
                                <div class="desc">Eclectic taste across Sci-Fi, Documentary, Thriller. High completion rates. Loves discovering hidden gems and thought-provoking content.</div>
                            </div>
                        </div>
                        <div class="feature-item">
                            <span class="icon">ğŸ“º</span>
                            <div class="text">
                                <div class="title">Maya (The Binge Watcher)</div>
                                <div class="desc">Series enthusiast who loves Drama, Comedy, Romance. Weekend marathon sessions. Prefers emotional, character-driven stories.</div>
                            </div>
                        </div>
                        <div class="feature-item">
                            <span class="icon">ğŸ’¥</span>
                            <div class="text">
                                <div class="title">Jake (The Thrill Seeker)</div>
                                <div class="desc">Action, Horror, Crime fanatic. Late-night viewer who craves high-energy, edge-of-seat content. Fast-paced and intense.</div>
                            </div>
                        </div>
                        <div class="feature-item">
                            <span class="icon">ğŸŒ™</span>
                            <div class="text">
                                <div class="title">Sofia (The Relaxer)</div>
                                <div class="desc">Light comedies, feel-good movies, animation. Evening wind-down viewer. Comfort rewatches and family-friendly content.</div>
                            </div>
                        </div>
                        <div class="feature-item" style="grid-column: span 2;">
                            <span class="icon">ğŸ‘¤</span>
                            <div class="text">
                                <div class="title">Guest (New User)</div>
                                <div class="desc">Fresh profile with no watch history - perfect for testing cold-start recommendations and seeing how the system handles new users without personalization data.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Provenance -->
                <div class="about-section">
                    <h3>ğŸ“œ Recommendation Provenance</h3>
                    <p>Every recommendation includes transparent reasoning:</p>
                    <div class="algorithm-box">
                        <pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PROVENANCE CERTIFICATE                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ ğŸ“Š Evidence Trajectories: 127                                   â”‚
â”‚    (Number of similar user journeys analyzed)                   â”‚
â”‚                                                                  â”‚
â”‚ ğŸ¯ Confidence Interval: [0.82, 0.91]                            â”‚
â”‚    (Statistical confidence in the recommendation)               â”‚
â”‚                                                                  â”‚
â”‚ ğŸ‘¥ Similar Users Completed: 87%                                 â”‚
â”‚    (Completion rate among similar viewers)                      â”‚
â”‚                                                                  â”‚
â”‚ ğŸ’¡ Reasoning: "matches your unwind mood, has a laugh tone,      â”‚
â”‚               currently trending, using Friday Unwind skill"    â”‚
â”‚                                                                  â”‚
â”‚ âš¡ Skill Used: Friday Unwind (confidence: 0.89)                 â”‚
â”‚    (Which learned strategy was applied)                         â”‚
â”‚                                                                  â”‚
â”‚ ğŸ“ˆ Causal Uplift: +12%                                          â”‚
â”‚    (Expected improvement over baseline)                         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        </pre>
                    </div>
                </div>

                <!-- Future Roadmap -->
                <div class="about-section">
                    <h3>ğŸš€ Future Enhancements</h3>
                    <div class="feature-grid">
                        <div class="feature-item">
                            <span class="icon">ğŸ¬</span>
                            <div class="text">
                                <div class="title">YouTube Integration</div>
                                <div class="desc">Trailers, reviews, and direct watch links</div>
                            </div>
                        </div>
                        <div class="feature-item">
                            <span class="icon">ğŸ“±</span>
                            <div class="text">
                                <div class="title">Streaming Links</div>
                                <div class="desc">Deep links to Netflix, Disney+, etc.</div>
                            </div>
                        </div>
                        <div class="feature-item">
                            <span class="icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>
                            <div class="text">
                                <div class="title">Social Context</div>
                                <div class="desc">Group recommendations for watch parties</div>
                            </div>
                        </div>
                        <div class="feature-item">
                            <span class="icon">ğŸ””</span>
                            <div class="text">
                                <div class="title">Smart Notifications</div>
                                <div class="desc">Proactive recommendations based on patterns</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="about-footer">
                <p>Built for the <strong>Agentics Hackathon 2024</strong> | Powered by <a href="https://www.themoviedb.org/" target="_blank">TMDB</a></p>
                <p style="margin-top: 8px; font-size: 11px;">Version 1.0.0 | Made with ğŸ’œ and lots of â˜•</p>
            </div>
        </div>
    </div>

    <!-- Single Column Layout -->
    <div class="split-container">
        <!-- Chat Interface - Full Width -->
        <div class="right-panel">
            <div class="chat-messages" id="messages">
                <!-- Messages will appear here -->
            </div>

            <div class="quick-chips" id="quickChips">
                <!-- Quick response chips -->
            </div>
        </div>
    </div>

    <script>
        let currentMood = null;
        let currentTone = null;
        let currentContent = [];
        let currentSessionId = null;
        let isListening = false;
        let speechRecognition = null;
        let currentUserId = 'alex-explorer';
        let demoUsers = [];

        // ============================================================================
        // User Selector System
        // ============================================================================

        async function loadDemoUsers() {
            try {
                const response = await fetch('/api/demo-users');
                const data = await response.json();
                demoUsers = data.users;
                currentUserId = data.defaultUserId;
                renderUserDropdown();
                updateCurrentUserDisplay();
            } catch (error) {
                console.error('Failed to load demo users:', error);
            }
        }

        function renderUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.innerHTML = demoUsers.map(user => `
                <div class="user-option ${user.id === currentUserId ? 'selected' : ''}" data-user-id="${user.id}">
                    <span class="user-avatar">${user.avatar}</span>
                    <div class="user-option-info">
                        <div class="user-option-name">${user.name}</div>
                        <div class="user-option-desc">${user.description.split(' - ')[0]}</div>
                    </div>
                    <span class="user-option-check">âœ“</span>
                </div>
            `).join('');

            // Add click handlers
            dropdown.querySelectorAll('.user-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const userId = option.dataset.userId;
                    selectUser(userId);
                });
            });
        }

        function updateCurrentUserDisplay() {
            const user = demoUsers.find(u => u.id === currentUserId);
            if (user) {
                document.getElementById('currentUserAvatar').textContent = user.avatar;
                document.getElementById('currentUserName').textContent = user.name;
                // Extract type from description (e.g., "The Explorer" -> "Explorer")
                const typeMatch = user.description.match(/The (\w+)/);
                document.getElementById('currentUserType').textContent = typeMatch ? typeMatch[1] : user.watchingStyle.split(',')[0];
            }
        }

        function selectUser(userId) {
            currentUserId = userId;

            // Update UI
            renderUserDropdown();
            updateCurrentUserDisplay();

            // Close dropdown
            document.getElementById('userSelector').classList.remove('open');

            // Get user persona for greeting
            const user = demoUsers.find(u => u.id === userId);

            // Reset conversation and greet new user
            messagesContainer.innerHTML = '';
            currentMood = null;
            currentTone = null;
            quickChipsContainer.innerHTML = '';

            // Personalized greeting based on user type
            let greeting = `Hey ${user.name}!`;
            if (user.id === 'test-user') {
                greeting = "Welcome! Let's find something great for you to watch.";
            } else if (user.primaryMood === 'engage') {
                greeting = `Hey ${user.name}! Ready for something exciting?`;
            } else {
                greeting = `Hey ${user.name}! Time to relax?`;
            }

            setTimeout(() => {
                addMessage(greeting, false, true, () => {
                    addMessage("What are you in the mood for?", false, true, () => {
                        addChoiceButtons([
                            { emoji: 'ğŸŒ™', label: 'Unwind', action: () => selectMood('unwind') },
                            { emoji: 'âš¡', label: 'Engage', action: () => selectMood('engage') }
                        ]);
                    });
                });
            }, 300);
        }

        // User selector toggle
        document.getElementById('userSelector').addEventListener('click', function(e) {
            if (e.target.closest('.user-dropdown')) return;
            this.classList.toggle('open');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const selector = document.getElementById('userSelector');
            if (!selector.contains(e.target)) {
                selector.classList.remove('open');
            }
        });

        // About Modal handlers
        document.getElementById('aboutButton').addEventListener('click', function() {
            document.getElementById('aboutModal').classList.add('active');
        });

        document.getElementById('aboutClose').addEventListener('click', function() {
            document.getElementById('aboutModal').classList.remove('active');
        });

        document.getElementById('aboutModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.getElementById('aboutModal').classList.remove('active');
            }
        });

        // Helper function to get skill icon based on skill ID
        function getSkillIcon(skillId) {
            const icons = {
                'friday_unwind': 'ğŸŒ™',
                'late_night_engage': 'ğŸŒƒ',
                'weekend_discovery': 'ğŸ”',
                'recovery_pivot': 'ğŸ”„',
                'default': 'âœ¨'
            };
            return icons[skillId] || icons['default'];
        }

        // Create ambient stars
        const starsContainer = document.getElementById('stars');
        for (let i = 0; i < 100; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.animationDelay = Math.random() * 3 + 's';
            starsContainer.appendChild(star);
        }

        // Orb animation system - same as chat.html
        class AuraOrb {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.resize();

                this.time = 0;
                this.mood = 'neutral';
                this.targetMood = 'neutral';
                this.transitionProgress = 0;

                this.particles = [];
                this.particleCount = 50;

                this.moodColors = {
                    neutral: { core: [200, 200, 220], glow: [150, 150, 200] },
                    unwind: { core: [138, 43, 226], glow: [186, 85, 211] },
                    engage: { core: [255, 165, 0], glow: [255, 215, 0] },
                    laugh: { core: [255, 105, 180], glow: [255, 160, 122] },
                    feel: { core: [30, 144, 255], glow: [64, 224, 208] },
                    thrill: { core: [220, 20, 60], glow: [255, 69, 0] },
                    think: { core: [46, 204, 113], glow: [0, 206, 209] }
                };

                this.initParticles();
            }

            resize() {
                const container = this.canvas.parentElement;
                const size = Math.min(container.offsetWidth, container.offsetHeight);
                this.canvas.width = size;
                this.canvas.height = size;
                this.centerX = size / 2;
                this.centerY = size / 2;
                this.baseRadius = size * 0.35;
            }

            initParticles() {
                this.particles = [];
                for (let i = 0; i < this.particleCount; i++) {
                    this.particles.push({
                        angle: Math.random() * Math.PI * 2,
                        distance: this.baseRadius * (1.5 + Math.random() * 0.5),
                        speed: 0.001 + Math.random() * 0.002,
                        size: 1 + Math.random() * 2,
                        opacity: Math.random()
                    });
                }
            }

            setMood(mood) {
                if (this.moodColors[mood]) {
                    this.targetMood = mood;
                    this.transitionProgress = 0;
                }
            }

            lerpColor(color1, color2, t) {
                return [
                    color1[0] + (color2[0] - color1[0]) * t,
                    color1[1] + (color2[1] - color1[1]) * t,
                    color1[2] + (color2[2] - color1[2]) * t
                ];
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.time += 0.01;

                // Smooth mood transition
                if (this.mood !== this.targetMood) {
                    this.transitionProgress += 0.02;
                    if (this.transitionProgress >= 1) {
                        this.mood = this.targetMood;
                        this.transitionProgress = 0;
                    }
                }

                const currentColors = this.moodColors[this.mood];
                const targetColors = this.moodColors[this.targetMood];
                const t = this.transitionProgress;

                const coreColor = this.lerpColor(currentColors.core, targetColors.core, t);
                const glowColor = this.lerpColor(currentColors.glow, targetColors.glow, t);

                // Breathing animation
                const breathe = Math.sin(this.time * 0.5) * 0.1 + 1;
                const radius = this.baseRadius * breathe;

                // Outer glow layers
                for (let i = 5; i > 0; i--) {
                    const glowRadius = radius * (1 + i * 0.15);
                    const gradient = this.ctx.createRadialGradient(
                        this.centerX, this.centerY, radius,
                        this.centerX, this.centerY, glowRadius
                    );

                    gradient.addColorStop(0, `rgba(${glowColor[0]}, ${glowColor[1]}, ${glowColor[2]}, ${0.3 / i})`);
                    gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');

                    this.ctx.fillStyle = gradient;
                    this.ctx.beginPath();
                    this.ctx.arc(this.centerX, this.centerY, glowRadius, 0, Math.PI * 2);
                    this.ctx.fill();
                }

                // Core orb with organic deformation
                this.ctx.beginPath();
                for (let angle = 0; angle < Math.PI * 2; angle += 0.1) {
                    const deform = Math.sin(angle * 3 + this.time) * 0.05 +
                                   Math.sin(angle * 5 - this.time * 2) * 0.03;
                    const r = radius * (1 + deform);
                    const x = this.centerX + Math.cos(angle) * r;
                    const y = this.centerY + Math.sin(angle) * r;

                    if (angle === 0) {
                        this.ctx.moveTo(x, y);
                    } else {
                        this.ctx.lineTo(x, y);
                    }
                }
                this.ctx.closePath();

                const coreGradient = this.ctx.createRadialGradient(
                    this.centerX, this.centerY, 0,
                    this.centerX, this.centerY, radius
                );
                coreGradient.addColorStop(0, `rgba(${coreColor[0]}, ${coreColor[1]}, ${coreColor[2]}, 1)`);
                coreGradient.addColorStop(0.6, `rgba(${coreColor[0]}, ${coreColor[1]}, ${coreColor[2]}, 0.6)`);
                coreGradient.addColorStop(1, `rgba(${glowColor[0]}, ${glowColor[1]}, ${glowColor[2]}, 0.2)`);

                this.ctx.fillStyle = coreGradient;
                this.ctx.fill();

                // Particles
                this.particles.forEach(particle => {
                    particle.angle += particle.speed;
                    particle.opacity = 0.3 + Math.sin(this.time * 2 + particle.angle * 5) * 0.3;

                    const x = this.centerX + Math.cos(particle.angle) * particle.distance;
                    const y = this.centerY + Math.sin(particle.angle) * particle.distance;

                    this.ctx.fillStyle = `rgba(${glowColor[0]}, ${glowColor[1]}, ${glowColor[2]}, ${particle.opacity})`;
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, particle.size, 0, Math.PI * 2);
                    this.ctx.fill();
                });
            }

            animate() {
                this.draw();
                requestAnimationFrame(() => this.animate());
            }
        }

        // Initialize header orb (2x logo size)
        const headerOrbCanvas = document.getElementById('headerOrbCanvas');
        const orb = new AuraOrb(headerOrbCanvas);
        orb.animate();

        // Chat system
        const messagesContainer = document.getElementById('messages');
        const quickChipsContainer = document.getElementById('quickChips');

        function addMessage(text, isUser = false, typewriter = false, callback = null) {
            const message = document.createElement('div');
            message.className = `message ${isUser ? 'user' : 'ai'}`;
            messagesContainer.appendChild(message);

            if (typewriter && !isUser) {
                typewriterEffect(message, text, 25, callback);
            } else {
                message.textContent = text;
                if (callback) callback();
            }

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return message;
        }

        function typewriterEffect(element, text, speed = 25, callback = null) {
            let i = 0;
            const interval = setInterval(() => {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                } else {
                    clearInterval(interval);
                    if (callback) callback();
                }
            }, speed);
        }

        // Add choice buttons inline in chat (with optional mic button)
        function addChoiceButtons(choices, container = null, includeMic = true) {
            const wrapper = document.createElement('div');
            wrapper.className = 'chat-choices';

            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'chat-choice-btn';
                btn.innerHTML = `<span class="emoji">${choice.emoji}</span><span class="label">${choice.label}</span>`;
                btn.addEventListener('click', () => {
                    // Disable all buttons in this group after selection
                    wrapper.querySelectorAll('.chat-choice-btn').forEach(b => {
                        b.style.opacity = '0.5';
                        b.style.pointerEvents = 'none';
                    });
                    btn.style.opacity = '1';
                    btn.style.background = 'rgba(168, 85, 247, 0.3)';
                    btn.style.borderColor = '#a855f7';
                    choice.action();
                });
                wrapper.appendChild(btn);
            });

            // Add mic button if requested
            if (includeMic) {
                const micBtn = document.createElement('button');
                micBtn.className = 'chat-choice-btn mic-choice';
                micBtn.innerHTML = `<span class="emoji">ğŸ¤</span><span class="label">Speak</span>`;
                micBtn.addEventListener('click', () => {
                    startVoiceInputForChoices(wrapper, choices);
                    micBtn.classList.toggle('listening');
                });
                wrapper.appendChild(micBtn);
            }

            if (container) {
                container.appendChild(wrapper);
            } else {
                messagesContainer.appendChild(wrapper);
            }
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return wrapper;
        }

        // Voice input for choice selection
        function startVoiceInputForChoices(wrapper, choices) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                addMessage("Sorry, voice input isn't supported in your browser.", false, true);
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 3;

            // Vibrate to indicate listening
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }

            recognition.onresult = (event) => {
                // Get best transcript from alternatives
                let transcript = event.results[0][0].transcript.toLowerCase();
                console.log('Voice input:', transcript, 'Confidence:', event.results[0][0].confidence);

                // Find matching choice
                let matchedChoice = null;
                for (const choice of choices) {
                    const label = choice.label.toLowerCase();
                    if (transcript.includes(label) ||
                        transcript.includes(choice.emoji) ||
                        (label.includes('unwind') && (transcript.includes('relax') || transcript.includes('chill') || transcript.includes('unwind'))) ||
                        (label.includes('engage') && (transcript.includes('excit') || transcript.includes('engage') || transcript.includes('action'))) ||
                        (label.includes('laugh') && (transcript.includes('laugh') || transcript.includes('funny') || transcript.includes('comedy'))) ||
                        (label.includes('feel') && (transcript.includes('feel') || transcript.includes('emotion') || transcript.includes('drama'))) ||
                        (label.includes('thrill') && (transcript.includes('thrill') || transcript.includes('action') || transcript.includes('suspense'))) ||
                        (label.includes('think') && (transcript.includes('think') || transcript.includes('mind') || transcript.includes('smart')))) {
                        matchedChoice = choice;
                        break;
                    }
                }

                // Disable buttons and trigger action
                wrapper.querySelectorAll('.chat-choice-btn').forEach(b => {
                    b.style.opacity = '0.5';
                    b.style.pointerEvents = 'none';
                });
                wrapper.querySelector('.mic-choice')?.classList.remove('listening');

                if (matchedChoice) {
                    matchedChoice.action();
                } else {
                    addMessage(`I heard "${transcript}" - let me pick something for you!`, false, true);
                    // Default to first choice if no match
                    choices[0].action();
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                wrapper.querySelector('.mic-choice')?.classList.remove('listening');
                // Vibrate on error
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
                if (event.error === 'no-speech') {
                    addMessage("I didn't hear anything. Tap the mic and speak clearly.", false, true);
                } else if (event.error !== 'aborted') {
                    addMessage("Couldn't hear you clearly. Please try again or tap a choice.", false, true);
                }
            };

            recognition.onend = () => {
                wrapper.querySelector('.mic-choice')?.classList.remove('listening');
            };

            recognition.start();
        }

        function setQuickChips(chips) {
            quickChipsContainer.innerHTML = '';
            chips.forEach(chip => {
                const chipEl = document.createElement('div');
                chipEl.className = 'chip';
                chipEl.textContent = chip.text;
                chipEl.addEventListener('click', () => chip.action());
                quickChipsContainer.appendChild(chipEl);
            });
        }

        function showDefaultChips() {
            setQuickChips([
                { text: 'ğŸ”„ Show me another', action: () => fetchRecommendation() },
                { text: 'ğŸ² Surprise me', action: () => startOver() },
                { text: 'â†©ï¸ Start over', action: () => startOver() }
            ]);
        }

        function startOver() {
            currentMood = null;
            currentTone = null;
            orb.setMood('neutral');
            quickChipsContainer.innerHTML = '';
            showMoodSelection();
        }

        // Show mood selection in chat
        function showMoodSelection() {
            addMessage("Hey! What are you in the mood for?", false, true, () => {
                addChoiceButtons([
                    { emoji: 'ğŸŒ™', label: 'Unwind', action: () => selectMood('unwind') },
                    { emoji: 'âš¡', label: 'Engage', action: () => selectMood('engage') }
                ]);
            });
        }

        // Select mood
        function selectMood(mood) {
            currentMood = mood;
            currentTone = null;
            orb.setMood(mood);

            const moodText = mood === 'unwind' ? 'I want to unwind' : 'I want something engaging';
            addMessage(moodText, true);

            setTimeout(() => {
                const question = mood === 'unwind'
                    ? "Nice, time to relax. What kind of vibe?"
                    : "Let's find something exciting. What sounds good?";

                addMessage(question, false, true, () => {
                    const toneChoices = mood === 'unwind'
                        ? [
                            { emoji: 'ğŸ˜„', label: 'Laugh', action: () => selectTone('laugh') },
                            { emoji: 'ğŸ­', label: 'Feel', action: () => selectTone('feel') }
                        ]
                        : [
                            { emoji: 'ğŸ”¥', label: 'Thrills', action: () => selectTone('thrill') },
                            { emoji: 'ğŸ§ ', label: 'Think', action: () => selectTone('think') }
                        ];
                    addChoiceButtons(toneChoices);
                });
            }, 400);
        }

        // Select tone
        function selectTone(tone) {
            currentTone = tone;
            orb.setMood(tone);

            const toneLabels = {
                laugh: 'Laugh',
                feel: 'Feel',
                thrill: 'Thrills',
                think: 'Think'
            };

            addMessage(toneLabels[tone] || tone, true);

            setTimeout(() => {
                addMessage('Perfect, let me find something for you...', false, true, () => {
                    setTimeout(() => fetchRecommendation(), 500);
                });
            }, 300);
        }

        // Fetch recommendation with alternatives
        async function fetchRecommendation() {
            try {
                const params = {
                    mood: currentMood || (Math.random() > 0.5 ? 'unwind' : 'engage'),
                    tone: currentTone || ['laugh', 'feel', 'thrill', 'think'][Math.floor(Math.random() * 4)],
                    includeAlternatives: true,
                    userId: currentUserId
                };

                const response = await fetch('/api/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });

                const data = await response.json();
                currentSessionId = data.sessionId;

                // Show the top pick with provenance and alternatives
                if (data.topPick) {
                    showContentCardWithAlternatives(data.topPick, data.alternatives || []);
                } else {
                    // Fallback to legacy format
                    showContentCard(data);
                }
                showDefaultChips();

            } catch (error) {
                console.error('Error fetching recommendation:', error);
                addMessage("Hmm, I'm having trouble finding something. Let's try again?", false, true);
            }
        }

        // Show content card in chat (legacy format)
        function showContentCard(data) {
            const card = document.createElement('div');
            card.className = 'message ai';
            card.innerHTML = `
                <div class="content-card">
                    <div class="card-image-container">
                        ${data.posterUrl
                            ? `<img class="card-image" src="${data.posterUrl}" alt="${data.title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`
                            : ''
                        }
                        <div class="card-image-fallback" style="${data.posterUrl ? 'display:none' : 'display:flex'}">
                            <span class="movie-icon">ğŸ¬</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-title">${data.title}</div>
                        <div class="card-match">âœ¨ ${data.match || 85}% match for you</div>
                        <div class="card-meta">${data.runtime || ''} ${data.runtime && data.year ? 'â€¢' : ''} ${data.year || ''}</div>
                        <div class="card-genres">${data.genres?.join(' â€¢ ') || ''}</div>
                        <div class="card-description">${data.description?.slice(0, 120) || data.overview?.slice(0, 120) || ''}...</div>
                        <div class="card-actions">
                            <button class="card-button primary" onclick="watchContent('${data.id}')">
                                â–¶ Watch
                            </button>
                            <button class="card-button secondary" onclick="saveContent('${data.title}', '${data.id}')">
                                ğŸ’¾ Save
                            </button>
                        </div>
                    </div>
                </div>
            `;

            messagesContainer.appendChild(card);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Show content card with provenance and alternatives
        function showContentCardWithAlternatives(topPick, alternatives) {
            const card = document.createElement('div');
            card.className = 'message ai';

            // Determine diversity label class
            const diversityClass = topPick.diversityType || 'safe';

            // Build provenance HTML if available (enhanced for Phase 2)
            let provenanceHtml = '';
            if (topPick.provenance) {
                const prov = topPick.provenance;

                // Skill badge section
                let skillHtml = '';
                if (prov.skillUsed && prov.skillUsed.name) {
                    const skillIcon = getSkillIcon(prov.skillUsed.id);
                    const confidence = Math.round(prov.skillUsed.confidence * 100);
                    skillHtml = `
                        <div class="card-provenance-skill">
                            <span class="skill-badge"><span class="skill-icon">${skillIcon}</span> ${prov.skillUsed.name}</span>
                            <span class="skill-confidence">${confidence}% confidence</span>
                        </div>
                    `;
                }

                // Learned weights section
                let weightsHtml = '';
                if (prov.learnedWeights) {
                    const weights = prov.learnedWeights;
                    const causalUplift = prov.causalUplift || 0;
                    const causalClass = causalUplift > 0 ? 'causal positive' : 'causal';
                    weightsHtml = `
                        <div class="card-provenance-weights">
                            <span class="weight-pill">sim: ${Math.round(weights.vectorSimilarity * 100)}%</span>
                            <span class="weight-pill">ctx: ${Math.round(weights.contextBoost * 100)}%</span>
                            <span class="weight-pill ${causalClass}">causal: +${Math.round(causalUplift * 100)}%</span>
                        </div>
                    `;
                }

                provenanceHtml = `
                    <div class="card-provenance">
                        ${skillHtml}
                        <span class="card-provenance-stat">${prov.similarUsersCompleted}</span> of similar users â€¢
                        ${prov.reasoning}
                        ${weightsHtml}
                    </div>
                `;
            }

            // Build alternatives HTML
            let alternativesHtml = '';
            if (alternatives && alternatives.length > 0) {
                const altCards = alternatives.map(alt => {
                    const altClass = alt.diversityType || '';
                    const altLabelClass = alt.diversityType === 'fast' ? 'fast' : (alt.diversityType === 'adventurous' ? 'adventurous' : 'safe');
                    return `
                        <div class="alt-card" onclick="selectAlternative('${alt.id}', '${alt.title.replace(/'/g, "\\'")}')">
                            ${alt.posterUrl
                                ? `<img class="alt-card-poster" src="${alt.posterUrl}" alt="${alt.title}" onerror="this.style.background='linear-gradient(135deg, #667eea 0%, #764ba2 100%)';">`
                                : `<div class="alt-card-poster"></div>`
                            }
                            <div class="alt-card-title">${alt.title}</div>
                            <div class="alt-card-meta">${alt.runtime || ''} â€¢ ${alt.match}%</div>
                            ${alt.diversityLabel ? `<span class="alt-card-label ${altLabelClass}">${alt.diversityLabel}</span>` : ''}
                        </div>
                    `;
                }).join('');

                alternativesHtml = `
                    <div class="alternatives-section">
                        <div class="alternatives-header">Or try one of these:</div>
                        <div class="alternatives-grid">${altCards}</div>
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="content-card">
                    <div class="card-image-container">
                        ${topPick.posterUrl
                            ? `<img class="card-image" src="${topPick.posterUrl}" alt="${topPick.title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`
                            : ''
                        }
                        <div class="card-image-fallback" style="${topPick.posterUrl ? 'display:none' : 'display:flex'}">
                            <span class="movie-icon">ğŸ¬</span>
                        </div>
                    </div>
                    <div class="card-content">
                        ${topPick.diversityLabel ? `<span class="card-diversity-label ${diversityClass}">${topPick.diversityLabel}</span>` : ''}
                        <div class="card-title">${topPick.title}</div>
                        <div class="card-scores">
                            <span class="card-score match">âœ¨ ${topPick.match || 85}% match</span>
                            <span class="card-score utility">ğŸ“Š ${topPick.utilityScore || topPick.match || 85}% utility</span>
                        </div>
                        ${provenanceHtml}
                        <div class="card-meta">${topPick.runtime || ''} ${topPick.runtime && topPick.year ? 'â€¢' : ''} ${topPick.year || ''} ${topPick.rating ? `â€¢ â­ ${topPick.rating.toFixed(1)}` : ''}</div>
                        <div class="card-genres">${topPick.genres?.join(' â€¢ ') || ''}</div>
                        <div class="card-description">${topPick.description?.slice(0, 150) || topPick.overview?.slice(0, 150) || ''}...</div>
                        <div class="card-actions">
                            <button class="card-button primary" onclick="watchContent('${topPick.id}')">
                                â–¶ Watch
                            </button>
                            <button class="card-button secondary" onclick="saveContent('${topPick.title.replace(/'/g, "\\'")}', '${topPick.id}')">
                                ğŸ’¾ Save
                            </button>
                        </div>
                    </div>
                </div>
                ${alternativesHtml}
            `;

            messagesContainer.appendChild(card);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Handle selecting an alternative
        async function selectAlternative(contentId, title) {
            addMessage(`Tell me more about "${title}"`, true);

            try {
                const response = await fetch(`/api/content/${contentId}`);
                const data = await response.json();

                if (data.error) {
                    addMessage("Let me find that for you...", false, true);
                    return;
                }

                setTimeout(() => {
                    addMessage(`Here's more about "${data.title}":`, false, true, () => {
                        showContentCard(data);
                    });
                }, 300);
            } catch (error) {
                console.error('Error fetching content:', error);
            }
        }

        function watchContent(contentId) {
            addMessage('Opening video player...', false, true);

            // Track watch start for outcome tracking
            if (currentSessionId && contentId) {
                fetch('/api/outcome/watch-start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: currentSessionId,
                        contentId: contentId
                    })
                }).catch(err => console.warn('Failed to track watch start:', err));
            }

            // In production, this would launch the streaming player
        }

        function saveContent(title, contentId) {
            addMessage(`Saved "${title}" to your watchlist!`, false, true);

            // Add to user's watchlist
            if (contentId) {
                fetch('/api/user/demo-user/watchlist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contentId })
                }).catch(err => console.warn('Failed to add to watchlist:', err));
            }
        }

        // Audio toggle placeholder
        document.getElementById('audioToggle').addEventListener('click', function() {
            this.style.background = this.style.background === 'rgba(100, 255, 100, 0.2)'
                ? 'rgba(255, 255, 255, 0.1)'
                : 'rgba(100, 255, 100, 0.2)';
        });

        // ============================================================================
        // Voice Input System (Web Speech API)
        // ============================================================================

        function initVoiceInput() {
            // Check for browser support
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                console.warn('Speech recognition not supported in this browser');
                // Hide mic buttons if not supported
                document.querySelectorAll('.mic-button-header, .mic-choice').forEach(el => {
                    el.style.display = 'none';
                });
                return;
            }

            // Check if on iOS Safari (has stricter requirements)
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            window.isIOSDevice = isIOS; // Store for later use

            // Track if Web Speech has failed on iOS (to auto-switch to Whisper)
            window.webSpeechFailedOnIOS = false;

            // Warn if not on HTTPS (required for iOS)
            if (isIOS && window.location.protocol !== 'https:') {
                console.warn('Voice input requires HTTPS on iOS Safari');
            }

            // Create new recognition instance each time for iOS compatibility
            function createRecognition() {
                const recognition = new SpeechRecognition();

                // iOS Safari works better with these settings
                if (isIOS) {
                    recognition.continuous = false;
                    recognition.interimResults = false; // iOS handles interim poorly
                    recognition.maxAlternatives = 5; // More alternatives for better matching
                } else {
                    recognition.continuous = false;
                    recognition.interimResults = true;
                    recognition.maxAlternatives = 3;
                }

                recognition.lang = 'en-US';
                return recognition;
            }

            speechRecognition = createRecognition();

            // Store collected speech for iOS (accumulate chunks)
            let collectedSpeech = '';
            let speechTimeout = null;

            speechRecognition.onstart = () => {
                isListening = true;
                collectedSpeech = '';
                document.getElementById('micButton').classList.add('listening');
                // Vibrate on mobile to confirm listening started
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
                addMessage('Listening... Speak now!', false, false);

                // iOS: Set a timeout to stop listening after 5 seconds of silence
                if (isIOS) {
                    speechTimeout = setTimeout(() => {
                        if (isListening && collectedSpeech) {
                            speechRecognition.stop();
                        }
                    }, 6000);
                }
            };

            speechRecognition.onend = () => {
                isListening = false;
                document.getElementById('micButton').classList.remove('listening');
                if (speechTimeout) {
                    clearTimeout(speechTimeout);
                    speechTimeout = null;
                }

                // iOS: Process collected speech on end
                if (isIOS && collectedSpeech.trim()) {
                    console.log('iOS collected speech:', collectedSpeech);
                    processVoiceCommand(collectedSpeech.toLowerCase().trim());
                    collectedSpeech = '';
                }

                // Recreate recognition for next use (iOS fix)
                speechRecognition = createRecognition();
                // Re-attach handlers
                speechRecognition.onstart = arguments.callee.caller ? speechRecognition.onstart : null;
            };

            speechRecognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                document.getElementById('micButton').classList.remove('listening');
                if (speechTimeout) {
                    clearTimeout(speechTimeout);
                    speechTimeout = null;
                }

                // On iOS, if Web Speech fails with certain errors, switch to Whisper
                if (isIOS && (event.error === 'no-speech' || event.error === 'network' || event.error === 'audio-capture')) {
                    console.log('Web Speech failed on iOS, switching to Whisper');
                    window.webSpeechFailedOnIOS = true;
                    addMessage("Switching to enhanced voice mode...", false, false);
                    setTimeout(() => startWhisperRecording(), 500);
                    speechRecognition = createRecognition();
                    return;
                }

                // Vibrate on error
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }

                if (event.error === 'no-speech') {
                    addMessage("I didn't hear anything. Tap the mic and speak clearly.", false, true);
                } else if (event.error === 'not-allowed' || event.error === 'permission-denied') {
                    addMessage("Microphone access denied. Go to Settings > Safari > Microphone to enable.", false, true);
                } else if (event.error === 'network') {
                    addMessage("Network error. Voice input requires an internet connection.", false, true);
                } else if (event.error === 'aborted') {
                    // User cancelled, no message needed
                } else {
                    addMessage("Voice input error. Please try again or type your request.", false, true);
                }

                // Recreate recognition for next use
                speechRecognition = createRecognition();
            };

            speechRecognition.onresult = (event) => {
                // Get all transcripts
                let fullTranscript = '';
                let bestConfidence = 0;

                for (let i = 0; i < event.results.length; i++) {
                    const result = event.results[i];

                    // iOS: Collect all results
                    if (isIOS) {
                        if (result.isFinal) {
                            // Get best alternative
                            let best = result[0].transcript;
                            for (let j = 1; j < result.length; j++) {
                                if (result[j].confidence > result[0].confidence) {
                                    best = result[j].transcript;
                                }
                            }
                            collectedSpeech += ' ' + best;
                        }
                    } else {
                        // Desktop: Use standard approach
                        for (let j = 0; j < result.length; j++) {
                            if (result[j].confidence > bestConfidence) {
                                bestConfidence = result[j].confidence;
                                fullTranscript = result[j].transcript;
                            }
                        }
                        if (result.isFinal) {
                            fullTranscript = result[0].transcript;
                            break;
                        }
                    }
                }

                // Desktop: Process immediately on final result
                if (!isIOS) {
                    const transcript = fullTranscript.toLowerCase().trim();
                    if (event.results[event.results.length - 1].isFinal && transcript) {
                        console.log('Voice recognized:', transcript, 'Confidence:', bestConfidence);
                        if (navigator.vibrate) {
                            navigator.vibrate(30);
                        }
                        processVoiceCommand(transcript);
                    }
                }
            };

            // Pre-request microphone permission on page load (helps iOS)
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        // Got permission, stop the stream immediately
                        stream.getTracks().forEach(track => track.stop());
                        console.log('Microphone permission granted');
                    })
                    .catch(err => {
                        console.warn('Microphone permission not granted:', err);
                    });
            }
        }

        // ============================================================================
        // Whisper-based Voice Input (for iOS and better accuracy)
        // ============================================================================

        let mediaRecorder = null;
        let audioChunks = [];
        let isRecordingWhisper = false;

        async function startWhisperRecording() {
            if (isRecordingWhisper) {
                stopWhisperRecording();
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000
                    }
                });

                // Use webm for best compatibility, or mp4 for iOS
                const mimeType = MediaRecorder.isTypeSupported('audio/webm')
                    ? 'audio/webm'
                    : 'audio/mp4';

                mediaRecorder = new MediaRecorder(stream, { mimeType });
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    stream.getTracks().forEach(track => track.stop());

                    if (audioChunks.length === 0) {
                        addMessage("No audio recorded. Please try again.", false, true);
                        return;
                    }

                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    await transcribeWithWhisper(audioBlob);
                };

                mediaRecorder.start();
                isRecordingWhisper = true;

                // Update UI
                document.getElementById('micButton').classList.add('listening');
                if (navigator.vibrate) navigator.vibrate(50);
                addMessage('Recording... Tap mic again to stop', false, false);

                // Auto-stop after 10 seconds
                setTimeout(() => {
                    if (isRecordingWhisper) {
                        stopWhisperRecording();
                    }
                }, 10000);

            } catch (error) {
                console.error('Failed to start recording:', error);
                addMessage("Microphone access denied. Please allow microphone in Settings.", false, true);
            }
        }

        function stopWhisperRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                isRecordingWhisper = false;
                document.getElementById('micButton').classList.remove('listening');
                addMessage('Processing your voice...', false, false);
            }
        }

        async function transcribeWithWhisper(audioBlob) {
            try {
                // Convert blob to base64
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);

                reader.onloadend = async () => {
                    const base64Audio = reader.result.split(',')[1]; // Remove data:audio/... prefix

                    const response = await fetch('/api/transcribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ audio_base64: base64Audio, language: 'en' })
                    });

                    const result = await response.json();

                    if (result.error) {
                        console.error('Transcription error:', result.error);
                        addMessage("Couldn't understand. Please try again.", false, true);
                        return;
                    }

                    const transcript = result.text?.trim();
                    if (transcript) {
                        console.log('Whisper transcription:', transcript);
                        if (navigator.vibrate) navigator.vibrate(30);
                        processVoiceCommand(transcript.toLowerCase());
                    } else {
                        addMessage("Didn't catch that. Please speak clearly.", false, true);
                    }
                };
            } catch (error) {
                console.error('Whisper API error:', error);
                addMessage("Voice processing failed. Please try again.", false, true);
            }
        }

        // Use Web Speech API first (real-time), fall back to Whisper if it fails
        function toggleVoiceInput() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

            // If Web Speech has failed on iOS before, use Whisper
            if (isIOS && window.webSpeechFailedOnIOS) {
                if (isRecordingWhisper) {
                    stopWhisperRecording();
                } else {
                    startWhisperRecording();
                }
                return;
            }

            // Try Web Speech API first (works real-time)
            if (speechRecognition) {
                if (isListening) {
                    speechRecognition.stop();
                } else {
                    try {
                        speechRecognition.start();
                    } catch (e) {
                        console.error('Speech recognition start error:', e);
                        // On iOS, fall back to Whisper
                        if (isIOS) {
                            window.webSpeechFailedOnIOS = true;
                            startWhisperRecording();
                        }
                    }
                }
            } else if (isIOS) {
                // No Web Speech API, use Whisper on iOS
                startWhisperRecording();
            }
        }

        function processVoiceCommand(transcript) {
            addMessage(transcript, true);

            // Parse voice commands for mood/tone
            const unwindKeywords = ['relax', 'unwind', 'chill', 'calm', 'peaceful', 'easy', 'light'];
            const engageKeywords = ['engage', 'exciting', 'intense', 'action', 'active', 'energetic', 'thrilling'];
            const laughKeywords = ['laugh', 'funny', 'comedy', 'humor', 'hilarious', 'joke'];
            const feelKeywords = ['feel', 'emotional', 'drama', 'touching', 'sad', 'romantic', 'love'];
            const thrillKeywords = ['thrill', 'action', 'adventure', 'exciting', 'suspense', 'intense'];
            const thinkKeywords = ['think', 'documentary', 'learn', 'educational', 'thought', 'mystery', 'smart'];

            let detectedMood = null;
            let detectedTone = null;

            // Detect mood
            if (unwindKeywords.some(k => transcript.includes(k))) {
                detectedMood = 'unwind';
            } else if (engageKeywords.some(k => transcript.includes(k))) {
                detectedMood = 'engage';
            }

            // Detect tone
            if (laughKeywords.some(k => transcript.includes(k))) {
                detectedTone = 'laugh';
            } else if (feelKeywords.some(k => transcript.includes(k))) {
                detectedTone = 'feel';
            } else if (thrillKeywords.some(k => transcript.includes(k))) {
                detectedTone = 'thrill';
            } else if (thinkKeywords.some(k => transcript.includes(k))) {
                detectedTone = 'think';
            }

            // Handle specific commands
            if (transcript.includes('surprise') || transcript.includes('random') || transcript.includes('anything')) {
                addMessage("Let me surprise you with something!", false, true, () => {
                    currentMood = Math.random() > 0.5 ? 'unwind' : 'engage';
                    currentTone = ['laugh', 'feel', 'thrill', 'think'][Math.floor(Math.random() * 4)];
                    orb.setMood(currentTone);
                    setTimeout(() => fetchRecommendation(), 500);
                });
                return;
            }

            if (transcript.includes('another') || transcript.includes('different') || transcript.includes('something else')) {
                addMessage("Let me find something else for you...", false, true, () => {
                    setTimeout(() => fetchRecommendation(), 500);
                });
                return;
            }

            if (transcript.includes('start over') || transcript.includes('reset')) {
                startOver();
                return;
            }

            // If we detected both mood and tone, go directly to recommendation
            if (detectedMood && detectedTone) {
                currentMood = detectedMood;
                currentTone = detectedTone;
                orb.setMood(detectedTone);
                addMessage(`Looking for something to ${detectedMood} with a ${detectedTone} vibe...`, false, true, () => {
                    setTimeout(() => fetchRecommendation(), 500);
                });
                return;
            }

            // If we only detected mood, ask for tone
            if (detectedMood && !detectedTone) {
                selectMood(detectedMood);
                return;
            }

            // If we only detected tone but no mood, infer mood
            if (!detectedMood && detectedTone) {
                currentMood = (detectedTone === 'laugh' || detectedTone === 'feel') ? 'unwind' : 'engage';
                currentTone = detectedTone;
                orb.setMood(detectedTone);
                addMessage(`Got it! Finding something to make you ${detectedTone}...`, false, true, () => {
                    setTimeout(() => fetchRecommendation(), 500);
                });
                return;
            }

            // Default: show mood selection
            setTimeout(() => {
                addMessage("I'm not sure what you're looking for. Let me help!", false, true, () => {
                    addChoiceButtons([
                        { emoji: 'ğŸŒ™', label: 'Unwind', action: () => selectMood('unwind') },
                        { emoji: 'âš¡', label: 'Engage', action: () => selectMood('engage') }
                    ]);
                });
            }, 300);
        }

        // Initialize voice input on load
        initVoiceInput();

        // Mic button click handler
        document.getElementById('micButton').addEventListener('click', toggleVoiceInput);

        // Welcome message on load - start the conversation
        // Load demo users first, then show greeting
        loadDemoUsers().then(() => {
            setTimeout(() => {
                showMoodSelection();
            }, 500);
        });
    </script>
</body>
</html>
