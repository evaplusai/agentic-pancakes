<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What to Watch in 60 Seconds - TV5MONDE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%);
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo p {
            color: #888;
            margin-top: 8px;
            font-size: 14px;
        }

        h2 {
            text-align: center;
            font-size: 32px;
            margin-bottom: 40px;
            line-height: 1.3;
        }

        .choices {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 40px;
        }

        .choice-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 40px 20px;
            font-size: 24px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .choice-btn:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.1);
            border-color: #e91e63;
            box-shadow: 0 8px 32px rgba(233, 30, 99, 0.3);
        }

        .choice-btn .emoji {
            font-size: 48px;
        }

        .choice-btn .label {
            font-size: 20px;
            font-weight: 600;
        }

        .processing {
            text-align: center;
        }

        .spinner {
            width: 80px;
            height: 80px;
            margin: 40px auto;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #e91e63;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .processing-text {
            font-size: 18px;
            color: #aaa;
            margin-bottom: 40px;
        }

        .checks {
            max-width: 400px;
            margin: 0 auto;
            text-align: left;
        }

        .check-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 12px;
            opacity: 0;
            transform: translateX(-20px);
        }

        .check-item.visible {
            animation: slideIn 0.5s ease-out forwards;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .check-mark {
            width: 24px;
            height: 24px;
            background: #4caf50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .result-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            overflow: hidden;
            max-width: 600px;
            margin: 0 auto;
        }

        .result-poster {
            width: 100%;
            height: 350px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 120px;
            position: relative;
        }

        .match-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #4caf50;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 700;
        }

        .trending-badge {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #e91e63;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .result-content {
            padding: 30px;
        }

        .result-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .result-meta {
            display: flex;
            gap: 16px;
            color: #aaa;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .result-description {
            line-height: 1.6;
            color: #ccc;
            margin-bottom: 24px;
        }

        .result-genres {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 24px;
        }

        .genre-tag {
            background: rgba(233, 30, 99, 0.2);
            border: 1px solid rgba(233, 30, 99, 0.4);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
        }

        .watch-btn {
            width: 100%;
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 18px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .watch-btn:hover {
            transform: scale(1.02);
        }

        .secondary-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .secondary-btn {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px;
            font-size: 14px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .secondary-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #e91e63;
        }

        .format-choice {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 40px;
        }

        .format-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px 40px;
            font-size: 18px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .format-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #e91e63;
        }

        .skip-link {
            text-align: center;
            margin-top: 24px;
            color: #888;
            font-size: 14px;
            cursor: pointer;
        }

        .skip-link:hover {
            color: #e91e63;
        }

        /* Home Screen Styles */
        .user-header {
            display: flex;
            align-items: center;
            gap: 16px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 32px;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .user-stats {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: #888;
        }

        .search-box {
            margin-bottom: 32px;
        }

        .search-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px 20px;
            font-size: 16px;
            color: white;
            transition: all 0.3s ease;
        }

        .search-input::placeholder {
            color: #666;
        }

        .search-input:focus {
            outline: none;
            border-color: #e91e63;
            background: rgba(255, 255, 255, 0.08);
        }

        .section {
            margin-bottom: 48px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
        }

        .see-all {
            color: #e91e63;
            font-size: 14px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .see-all:hover {
            opacity: 0.8;
        }

        .carousel {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 12px;
            scrollbar-width: thin;
            scrollbar-color: #e91e63 rgba(255, 255, 255, 0.05);
        }

        .carousel::-webkit-scrollbar {
            height: 8px;
        }

        .carousel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .carousel::-webkit-scrollbar-thumb {
            background: #e91e63;
            border-radius: 4px;
        }

        .content-card {
            flex: 0 0 280px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .content-card:hover {
            transform: translateY(-4px);
            border-color: #e91e63;
            box-shadow: 0 8px 32px rgba(233, 30, 99, 0.3);
        }

        .content-poster {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            position: relative;
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(0, 0, 0, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: #e91e63;
            transition: width 0.3s;
        }

        .content-info {
            padding: 16px;
        }

        .content-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .content-meta {
            font-size: 13px;
            color: #888;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .start-quiz-btn {
            width: 100%;
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            border: none;
            border-radius: 12px;
            padding: 20px;
            font-size: 18px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 32px;
        }

        .start-quiz-btn:hover {
            transform: scale(1.02);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        @media (max-width: 640px) {
            .choices {
                grid-template-columns: 1fr;
            }

            h2 {
                font-size: 24px;
            }

            .choice-btn {
                padding: 30px 20px;
            }

            .result-poster {
                height: 250px;
                font-size: 80px;
            }

            .format-choice {
                flex-direction: column;
            }

            .content-card {
                flex: 0 0 200px;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .user-header {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1>TV5MONDE</h1>
            <p>What to Watch in 60 Seconds</p>
        </div>

        <!-- Home Screen with Personalization -->
        <div id="screen-home" class="screen">
            <!-- User Profile Header -->
            <div class="user-header" id="user-header">
                <div class="user-avatar" id="user-avatar">M</div>
                <div class="user-info">
                    <div class="user-name" id="user-name">Loading...</div>
                    <div class="user-stats">
                        <span id="watch-count">0 watched</span>
                        <span>â€¢</span>
                        <span id="watchlist-count">0 saved</span>
                    </div>
                </div>
            </div>

            <!-- Search Box -->
            <div class="search-box">
                <input
                    type="text"
                    class="search-input"
                    id="search-input"
                    placeholder="Search by mood, genre, or description..."
                    onkeypress="handleSearchKeypress(event)"
                />
            </div>

            <!-- Start Quiz Button -->
            <button class="start-quiz-btn" onclick="startQuiz()">
                ðŸŽ¯ Find My Perfect Match (60 seconds)
            </button>

            <!-- Continue Watching Section -->
            <div class="section" id="continue-watching-section" style="display: none;">
                <div class="section-header">
                    <h3 class="section-title">Continue Watching</h3>
                </div>
                <div class="carousel" id="continue-watching-carousel">
                    <!-- Dynamic content cards -->
                </div>
            </div>

            <!-- Personalized Trending Section -->
            <div class="section" id="trending-section" style="display: none;">
                <div class="section-header">
                    <h3 class="section-title">Trending for You</h3>
                </div>
                <div class="carousel" id="trending-carousel">
                    <!-- Dynamic content cards -->
                </div>
            </div>

            <!-- Watchlist Section -->
            <div class="section" id="watchlist-section" style="display: none;">
                <div class="section-header">
                    <h3 class="section-title">Your Watchlist</h3>
                    <span class="see-all" onclick="showAllWatchlist()">See all â†’</span>
                </div>
                <div class="grid" id="watchlist-grid">
                    <!-- Dynamic content cards -->
                </div>
            </div>
        </div>

        <!-- Welcome Screen -->
        <div id="screen-welcome" class="screen active">
            <h2>What are you in the mood for tonight?</h2>
            <div class="choices">
                <button class="choice-btn" onclick="selectMood('unwind')">
                    <span class="emoji">ðŸŒ™</span>
                    <span class="label">Unwind</span>
                </button>
                <button class="choice-btn" onclick="selectMood('engage')">
                    <span class="emoji">âš¡</span>
                    <span class="label">Engage</span>
                </button>
            </div>
        </div>

        <!-- Secondary Choice: Unwind -->
        <div id="screen-unwind" class="screen">
            <h2>How do you want to unwind?</h2>
            <div class="choices">
                <button class="choice-btn" onclick="selectTone('laugh')">
                    <span class="emoji">ðŸ˜„</span>
                    <span class="label">Laugh</span>
                </button>
                <button class="choice-btn" onclick="selectTone('feel')">
                    <span class="emoji">ðŸŽ­</span>
                    <span class="label">Feel</span>
                </button>
            </div>
        </div>

        <!-- Secondary Choice: Engage -->
        <div id="screen-engage" class="screen">
            <h2>What kind of engagement?</h2>
            <div class="choices">
                <button class="choice-btn" onclick="selectTone('thrill')">
                    <span class="emoji">ðŸ”¥</span>
                    <span class="label">Thrill</span>
                </button>
                <button class="choice-btn" onclick="selectTone('think')">
                    <span class="emoji">ðŸ§ </span>
                    <span class="label">Think</span>
                </button>
            </div>
        </div>

        <!-- Format Choice -->
        <div id="screen-format" class="screen">
            <h2>Movie or Series?</h2>
            <div class="format-choice">
                <button class="format-btn" onclick="selectFormat('movie')">
                    <span>ðŸŽ¬</span>
                    <span>Movie</span>
                </button>
                <button class="format-btn" onclick="selectFormat('series')">
                    <span>ðŸ“º</span>
                    <span>Series</span>
                </button>
            </div>
            <div class="skip-link" onclick="selectFormat('any')">
                Surprise me â†’
            </div>
        </div>

        <!-- Processing Screen -->
        <div id="screen-processing" class="screen">
            <div class="processing">
                <div class="spinner"></div>
                <div class="processing-text">Analyzing 2,847 titles for your perfect match...</div>
                <div class="checks">
                    <div class="check-item" id="check-1">
                        <div class="check-mark">âœ“</div>
                        <div>Checked trending charts</div>
                    </div>
                    <div class="check-item" id="check-2">
                        <div class="check-mark">âœ“</div>
                        <div>Matched your taste profile</div>
                    </div>
                    <div class="check-item" id="check-3">
                        <div class="check-mark">âœ“</div>
                        <div>Found 3 perfect picks</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="screen-result" class="screen">
            <div class="result-card">
                <div class="result-poster" id="result-poster">
                    ðŸŽ¬
                    <div class="match-badge" id="match-badge">94% match</div>
                    <div class="trending-badge" id="trending-badge" style="display: none;">ðŸ”¥ Trending</div>
                </div>
                <div class="result-content">
                    <h3 class="result-title" id="result-title">The Perfect Match</h3>
                    <div class="result-meta">
                        <span id="result-runtime">2h 15m</span>
                        <span>â€¢</span>
                        <span id="result-year">2024</span>
                    </div>
                    <div class="result-description" id="result-description">
                        A captivating story that perfectly matches your current mood...
                    </div>
                    <div class="result-genres" id="result-genres">
                        <span class="genre-tag">Drama</span>
                        <span class="genre-tag">Romance</span>
                    </div>
                    <button class="watch-btn" onclick="watchNow()">
                        â–¶ WATCH NOW ON TV5MONDE
                    </button>
                    <div class="secondary-actions">
                        <button class="secondary-btn" onclick="restart()">Something else?</button>
                        <button class="secondary-btn" onclick="surpriseMe()">Surprise me</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const userId = 'demo-user';
        let preferences = {
            mood: null,
            tone: null,
            format: null
        };
        let currentScreen = 'home';

        const mockResults = {
            'unwind-laugh-movie': {
                title: 'Ã€ Table!',
                emoji: 'ðŸ½ï¸',
                runtime: '1h 45m',
                year: '2024',
                description: 'A delightful French comedy about a family reunion where decades of secrets bubble to the surface over a memorable dinner. Heartwarming and hilarious.',
                genres: ['Comedy', 'Drama', 'French Cinema'],
                match: 96,
                trending: true
            },
            'unwind-laugh-series': {
                title: 'CafÃ© de la Plage',
                emoji: 'â˜•',
                runtime: '8 episodes Ã— 45m',
                year: '2024',
                description: 'A charming coastal cafÃ© becomes the backdrop for love, laughter, and the quirky residents of a French seaside town.',
                genres: ['Comedy', 'Romance', 'Series'],
                match: 94,
                trending: true
            },
            'unwind-feel-movie': {
                title: 'Les Saisons du Coeur',
                emoji: 'ðŸ’',
                runtime: '2h 10m',
                year: '2023',
                description: 'An emotional journey through love and loss, set against the stunning backdrop of the French countryside across four seasons.',
                genres: ['Drama', 'Romance', 'Art House'],
                match: 95,
                trending: false
            },
            'unwind-feel-series': {
                title: 'Lettres d\'Amour',
                emoji: 'ðŸ’Œ',
                runtime: '6 episodes Ã— 52m',
                year: '2024',
                description: 'Discovered love letters from WWII connect two strangers across time in this beautifully crafted romantic drama.',
                genres: ['Romance', 'Historical', 'Drama'],
                match: 93,
                trending: false
            },
            'engage-thrill-movie': {
                title: 'Minuit Ã  Paris',
                emoji: 'ðŸŒƒ',
                runtime: '2h 05m',
                year: '2024',
                description: 'A gripping thriller where a detective has until midnight to solve a case that will shake Paris to its core. Edge-of-your-seat suspense.',
                genres: ['Thriller', 'Mystery', 'Crime'],
                match: 97,
                trending: true
            },
            'engage-thrill-series': {
                title: 'La Traque',
                emoji: 'ðŸ”',
                runtime: '8 episodes Ã— 48m',
                year: '2024',
                description: 'An elite investigator pursues a master criminal across Europe in this pulse-pounding crime series.',
                genres: ['Crime', 'Thriller', 'Action'],
                match: 96,
                trending: true
            },
            'engage-think-movie': {
                title: 'Le Paradoxe',
                emoji: 'ðŸ§©',
                runtime: '2h 20m',
                year: '2023',
                description: 'A mind-bending sci-fi drama exploring consciousness, time, and the nature of reality through the eyes of a quantum physicist.',
                genres: ['Sci-Fi', 'Drama', 'Philosophy'],
                match: 94,
                trending: false
            },
            'engage-think-series': {
                title: 'Archives SecrÃ¨tes',
                emoji: 'ðŸ“š',
                runtime: '10 episodes Ã— 55m',
                year: '2024',
                description: 'Historians uncover conspiracies hidden in plain sight throughout French history. Intelligent and thought-provoking.',
                genres: ['Historical', 'Mystery', 'Documentary'],
                match: 92,
                trending: false
            }
        };

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;
        }

        // Initialize home screen on load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadUserProfile();
            await loadContinueWatching();
            await loadPersonalizedTrending();
            await loadWatchlist();
            showScreen('screen-home');
        });

        // Load user profile
        async function loadUserProfile() {
            try {
                const response = await fetch(`/api/user/${userId}`);
                if (!response.ok) throw new Error('Failed to load user');

                const user = await response.json();
                document.getElementById('user-name').textContent = user.displayName || 'Guest';
                document.getElementById('user-avatar').textContent = getInitials(user.displayName || 'Guest');
                document.getElementById('watch-count').textContent = `${user.watchStats?.totalWatched || 0} watched`;
                document.getElementById('watchlist-count').textContent = `${user.watchStats?.watchlistCount || 0} saved`;
            } catch (error) {
                console.error('Error loading user profile:', error);
                // Use defaults if API fails
                document.getElementById('user-name').textContent = 'Marie';
                document.getElementById('user-avatar').textContent = 'M';
            }
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        // Load continue watching
        async function loadContinueWatching() {
            try {
                const response = await fetch(`/api/user/${userId}/continue-watching`);
                if (!response.ok) throw new Error('Failed to load continue watching');

                const items = await response.json();
                if (items.length > 0) {
                    const carousel = document.getElementById('continue-watching-carousel');
                    carousel.innerHTML = items.map(item => createContentCard(item, true)).join('');
                    document.getElementById('continue-watching-section').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading continue watching:', error);
            }
        }

        // Load personalized trending
        async function loadPersonalizedTrending() {
            try {
                const response = await fetch(`/api/user/${userId}/trending`);
                if (!response.ok) throw new Error('Failed to load trending');

                const items = await response.json();
                if (items.length > 0) {
                    const carousel = document.getElementById('trending-carousel');
                    carousel.innerHTML = items.map(item => createContentCard(item, false)).join('');
                    document.getElementById('trending-section').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading trending:', error);
            }
        }

        // Load watchlist
        async function loadWatchlist() {
            try {
                const response = await fetch(`/api/user/${userId}/watchlist/content`);
                if (!response.ok) throw new Error('Failed to load watchlist');

                const items = await response.json();
                if (items.length > 0) {
                    const grid = document.getElementById('watchlist-grid');
                    grid.innerHTML = items.slice(0, 4).map(item => createContentCard(item, false)).join('');
                    document.getElementById('watchlist-section').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading watchlist:', error);
            }
        }

        // Create content card HTML
        function createContentCard(item, showProgress = false) {
            const emoji = getEmojiForGenre(item.genres?.[0] || 'Drama');
            const progress = showProgress && item.progress ? item.progress : 0;

            return `
                <div class="content-card" onclick="playContent('${item.id}')">
                    <div class="content-poster">
                        ${emoji}
                        ${showProgress ? `
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="content-info">
                        <div class="content-title">${item.title}</div>
                        <div class="content-meta">
                            <span>${item.year || '2024'}</span>
                            ${showProgress ? `<span>â€¢ ${Math.round(progress)}% watched</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function getEmojiForGenre(genre) {
            const emojiMap = {
                'Comedy': 'ðŸ˜„',
                'Drama': 'ðŸŽ­',
                'Thriller': 'ðŸ”¥',
                'Romance': 'ðŸ’',
                'Crime': 'ðŸ”',
                'Sci-Fi': 'ðŸ§©',
                'Historical': 'ðŸ“š',
                'Action': 'âš¡'
            };
            return emojiMap[genre] || 'ðŸŽ¬';
        }

        // Handle search
        async function handleSearchKeypress(event) {
            if (event.key === 'Enter') {
                const query = event.target.value.trim();
                if (query) {
                    await performSearch(query);
                }
            }
        }

        async function performSearch(query) {
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, limit: 10 })
                });

                if (!response.ok) throw new Error('Search failed');

                const results = await response.json();
                displaySearchResults(results);
            } catch (error) {
                console.error('Search error:', error);
                alert('Search is currently unavailable. Please try again later.');
            }
        }

        function displaySearchResults(results) {
            // For now, just show an alert with the count
            // In production, you'd show a search results screen
            alert(`Found ${results.length} results matching your search!`);
        }

        function playContent(contentId) {
            alert(`Playing content: ${contentId}\n\n(In production, this would launch the video player)`);
        }

        function showAllWatchlist() {
            alert('Showing full watchlist\n\n(In production, this would navigate to a dedicated watchlist page)');
        }

        function startQuiz() {
            showScreen('screen-welcome');
        }

        function selectMood(mood) {
            preferences.mood = mood;
            showScreen(`screen-${mood}`);
        }

        function selectTone(tone) {
            preferences.tone = tone;
            showScreen('screen-format');
        }

        function selectFormat(format) {
            preferences.format = format;
            processRecommendation();
        }

        async function processRecommendation() {
            showScreen('screen-processing');

            // Animate check marks
            setTimeout(() => document.getElementById('check-1').classList.add('visible'), 500);
            setTimeout(() => document.getElementById('check-2').classList.add('visible'), 1200);
            setTimeout(() => document.getElementById('check-3').classList.add('visible'), 1900);

            // Fetch recommendation from API
            const recommendation = await getRecommendation();

            // Show result after processing (minimum 3 seconds for UX)
            setTimeout(() => {
                displayResult(recommendation);
            }, 3000);
        }

        function displayResult(apiResult) {
            // Use API result if available, otherwise fallback to mock data
            let result;
            if (apiResult && !apiResult.error) {
                result = {
                    emoji: 'ðŸŽ¬',
                    title: apiResult.title,
                    runtime: apiResult.runtime,
                    year: apiResult.year,
                    description: apiResult.description,
                    genres: apiResult.genres,
                    match: apiResult.match,
                    trending: apiResult.trending
                };
            } else {
                // Fallback to mock data
                const key = `${preferences.mood}-${preferences.tone}-${preferences.format === 'any' ? 'movie' : preferences.format}`;
                result = mockResults[key] || mockResults['unwind-laugh-movie'];
            }

            // Update result card
            document.getElementById('result-poster').innerHTML = `
                ${result.emoji}
                <div class="match-badge">${result.match}% match</div>
                ${result.trending ? '<div class="trending-badge">ðŸ”¥ Trending</div>' : ''}
            `;
            document.getElementById('result-title').textContent = result.title;
            document.getElementById('result-runtime').textContent = result.runtime;
            document.getElementById('result-year').textContent = result.year;
            document.getElementById('result-description').textContent = result.description;

            // Update genres
            const genresHtml = result.genres.map(g =>
                `<span class="genre-tag">${g}</span>`
            ).join('');
            document.getElementById('result-genres').innerHTML = genresHtml;

            showScreen('screen-result');
        }

        function watchNow() {
            alert('Opening TV5MONDE player...\n\n(In production, this would launch the video player)');
        }

        function restart() {
            preferences = { mood: null, tone: null, format: null };
            showScreen('screen-home');
        }

        async function surpriseMe() {
            // Pick a random recommendation
            const keys = Object.keys(mockResults);
            const randomKey = keys[Math.floor(Math.random() * keys.length)];
            const parts = randomKey.split('-');
            preferences.mood = parts[0];
            preferences.tone = parts[1];
            preferences.format = parts[2];

            await processRecommendation();
        }

        // Call API endpoint (when server is running)
        async function getRecommendation() {
            try {
                const response = await fetch('/api/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(preferences)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('API call failed, using mock data:', error);
                return null;
            }
        }
    </script>
</body>
</html>
